trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    exclude: 
    - README.md
    - LICENSE
    include:
    - api
    - website
    - pipelines/app/azure-pipelines.yml

parameters:
  - name: azureContainerRegistry
    default: ufjmmjtacr.azurecr.io
  - name: azureSubscriptionEndpoint
    default: AzureDevOps
  - name: dockerComposeFile
    default: api/docker-compose.yml
  - name: projectName
    default: api
  - name: qualifyImageNames
    default: true

pool:
  vmImage: ubuntu-latest

stages:
  - stage: main
    jobs:
    - template: ../templates/docker-compose/build-push.yml
      parameters:        
        azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
        azureContainerRegistry: ${{ parameters.azureContainerRegistry }}
        dockerComposeFile: db/docker-compose.yml
        projectName: mysql
        qualifyImageNames: true
        jobName: MySqlDockerCompose

    - job: NodeJSDockerCompose
      dependsOn: MySqlDockerCompose
      steps:

      - task: DockerCompose@0
        displayName: Build services
        inputs:
          action: Build services
          azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
          azureContainerRegistry: ${{ parameters.azureContainerRegistry }}
          dockerComposeFile: ${{ parameters.dockerComposeFile }}
          projectName: ${{ parameters.azureContainerRegistry }}
          qualifyImageNames: ${{ parameters.qualifyImageNames }}
          dockerComposeFileArgs: |
            MYSQL_HOST=""
            MYSQL_PORT=3306
          
      - task: DockerCompose@0
        displayName: Push services
        inputs:
          action: Push services
          containerregistrytype: Azure Container Registry
          azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
          azureContainerRegistry: ${{ parameters.azureContainerRegistry }}
          dockerComposeFile: ${{ parameters.dockerComposeFile }}
          projectName: ${{ parameters.projectName }}
          qualifyImageNames: ${{ parameters.qualifyImageNames }}
          dockerComposeFileArgs: |
            MYSQL_HOST="20.123.233.107"
            MYSQL_PORT=3306
