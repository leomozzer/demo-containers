trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    exclude: 
    - README.md
    - LICENSE
    include:
    - api
    - website
    - pipelines/app/azure-pipelines.yml

parameters:
  - name: app_name
    default: "demo-containers"
  - name: azureContainerRegistry
    default: hnvthifacr.azurecr.io
  - name: azureSubscriptionEndpoint
    default: AzureDevOps
  - name: dockerComposeFile
    default: api/docker-compose.yml
  - name: projectName
    default: api
  - name: qualifyImageNames
    default: true
  - name: databaseDir
    default: "terraform/app/database"

variables:
  - group: "demo-containers-group"
  - group: "demo-containers-acr-group"

pool:
  vmImage: ubuntu-latest

stages:
  - stage: main
    jobs:
    - job: MySql
      steps:
        
      - task: DockerCompose@0
        displayName: Build services
        inputs:
          action: Build services
          azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
          azureContainerRegistry: '$(acr-name).azurecr.io'
          dockerComposeFile: db/docker-compose.yml
          projectName: mysql
          qualifyImageNames: ${{ parameters.qualifyImageNames }}
          
      - task: DockerCompose@0
        displayName: Push services
        inputs:
          action: Push services
          containerregistrytype: Azure Container Registry
          azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
          azureContainerRegistry: '$(acr-name).azurecr.io'
          dockerComposeFile: db/docker-compose.yml
          projectName: mysql
          qualifyImageNames: ${{ parameters.qualifyImageNames }}

      - task: DownloadBuildArtifacts@0
        displayName: 'Get tfstate files'
        continueOnError: true
        inputs:
          buildType: 'current'
          downloadType: 'single'
          artifactName: 'tfstates-database'
          downloadPath: '$(System.ArtifactsDirectory)'

      - task: CopyFiles@2
        displayName: 'Move tfstate files'
        continueOnError: true
        inputs:
          SourceFolder: '$(System.ArtifactsDirectory)/'tfstates-database'
          Contents: |
            terraform.tfstate
          TargetFolder: '$(System.DefaultWorkingDirectory)/${{ parameters.databaseDir }}'

      - template: ../templates/steps/terraform.yml
        parameters:
          out_file: "main"
          input_vars:  '-var "app_name=${{ parameters.app_name }}-$(acr-name)" -var "subscription_id=$(SUBSCRIPTION-ID)" -var "client_id=$(CLIENT-ID)" -var "client_secret=$(CLIENT-SECRET)" -var "tenant_id=$(TENANT-ID)" -var "acr_username=$(acr-name)" -var "acr_password=$(acr-admin-password)" -var "acr_server=$(acr-name).azurecr.io"'
          include_root_rolder: true
          work_dir: ${{ parameters.databaseDir }}
          archive_type: 'tar'
          output_file: 'tf-database'
          artifact_name: 'tfstates-database'
      
      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)/${{ parameters.databaseDir }}'
          Contents: |
            terraform.tfstate
            output.json
          TargetFolder: '$(Build.ArtifactStagingDirectory)'

      - task: PublishBuildArtifacts@1
        inputs:
          pathToPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: 'tfstates-database'

    - job: NodeJS
      dependsOn: MySql
      steps:

      # - task: DownloadBuildArtifacts@0
      #   inputs:
      #     buildType: 'current'
      #     downloadType: 'single'
      #     artifactName: ${{ parameters.artifact_name }}
      #     downloadPath: '$(System.ArtifactsDirectory)'

      - task: DockerCompose@0
        displayName: Build services
        inputs:
          action: Build services
          azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
          azureContainerRegistry: '$(acr-name).azurecr.io'
          dockerComposeFile: api/docker-compose.yml
          projectName: api
          qualifyImageNames: ${{ parameters.qualifyImageNames }}
          dockerComposeFileArgs: |
            MYSQL_HOST=""
            MYSQL_PORT=3306
          
      - task: DockerCompose@0
        displayName: Push services
        inputs:
          action: Push services
          containerregistrytype: Azure Container Registry
          azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
          azureContainerRegistry: '$(acr-name).azurecr.io'
          dockerComposeFile: api/docker-compose.yml
          projectName: api
          qualifyImageNames: ${{ parameters.qualifyImageNames }}
          dockerComposeFileArgs: |
            MYSQL_HOST="20.123.233.107"
            MYSQL_PORT=3306
